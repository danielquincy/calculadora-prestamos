<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Pr√©stamos Amoretty</title>
    <!-- Importar Chart.js para los gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* =========================================
           ESTILOS CSS (Tema Oscuro "Amoretty")
           ========================================= */
        :root {
            --primary-color: #60a5fa; /* Azul m√°s brillante para fondo oscuro */
            --primary-hover: #3b82f6;
            --secondary-color: #94a3b8; /* Gris claro */
            --bg-color: #0f172a; /* Fondo muy oscuro (Slate 900) */
            --card-bg: #1e293b; /* Fondo de tarjetas (Slate 800) */
            --text-color: #f8fafc; /* Texto casi blanco */
            --border-color: #334155; /* Bordes sutiles */
            --input-bg: #020617; /* Fondo de inputs */
            --danger-color: #f87171;
            --success-color: #34d399;
            --table-hover: #2d3748;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            color: var(--primary-color);
            margin-bottom: 5px;
            font-size: 2.2rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        header p {
            color: var(--secondary-color);
        }

        /* Layout en Grid para Pantallas Grandes */
        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .calculator-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Tarjetas (Cards) */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
        }

        .card h2 {
            margin-top: 0;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.25rem;
            color: var(--primary-color);
        }

        /* Formularios */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--secondary-color);
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box; /* Asegura que el padding no rompa el ancho */
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
        }

        .input-hint {
            font-size: 0.8rem;
            color: var(--secondary-color);
            margin-top: 4px;
        }

        /* Botones */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: #0f172a; /* Texto oscuro para contraste */
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--secondary-color);
        }

        .btn-secondary:hover {
            background-color: rgba(255,255,255,0.05);
            color: var(--text-color);
        }

        .btn-success {
            background-color: var(--success-color);
            color: #064e3b;
        }
        
        .btn-success:hover {
            background-color: #10b981;
        }
        
        .btn-print {
            background-color: #8b5cf6; /* Violeta */
            color: white;
        }
        
        .btn-print:hover {
            background-color: #7c3aed;
        }

        /* Resultados y M√©tricas */
        .results-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .metric-box {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .metric-box.highlight {
            background: rgba(96, 165, 250, 0.1); /* Azul muy tenue */
            border-color: rgba(96, 165, 250, 0.3);
            grid-column: span 2;
        }

        .metric-label {
            display: block;
            font-size: 0.85rem;
            color: var(--secondary-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color);
            margin-top: 5px;
        }
        
        .metric-box.highlight .metric-value {
             color: var(--primary-color);
        }

        .metric-value.large {
            font-size: 2rem;
        }

        /* Mensajes de Error */
        #error-msg {
            display: none;
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 0.95rem;
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-left: 4px solid var(--danger-color);
        }

        /* Tabla */
        .table-container {
            overflow-x: auto;
            margin-top: 30px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            min-width: 600px; 
        }

        th, td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: rgba(0,0,0,0.3);
            color: var(--primary-color);
            font-weight: 600;
            text-align: right;
            position: sticky;
            top: 0;
        }
        
        th:first-child, td:first-child {
            text-align: center;
        }

        tbody tr:hover {
            background-color: var(--table-hover);
        }
        
        /* Ajuste de colores en filas de tabla para modo oscuro */
        td {
            color: var(--secondary-color);
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }

        /* Fila de periodo de gracia */
        .grace-period-row {
            background-color: rgba(234, 88, 12, 0.1); /* Naranja oscuro transparente */
        }
        
        .grace-period-row td {
            color: #fb923c;
        }

        /* Secci√≥n VAN/TIR */
        .financial-indicators {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed var(--border-color);
        }

        .indicator-input {
            width: 80px !important;
            display: inline-block !important;
            padding: 5px !important;
            font-size: 0.9rem !important;
            background: var(--bg-color) !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-color) !important;
        }
        
        /* Contenedor del Gr√°fico */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-top: 20px;
        }

        /* =========================================
           ESTILOS DE IMPRESI√ìN (PDF)
           ========================================= */
        @media print {
            body {
                background-color: #ffffff !important;
                color: #000000 !important;
                padding: 0;
            }

            .container {
                max-width: 100%;
                width: 100%;
                margin: 0;
            }

            header h1 {
                color: #2563eb !important; /* Azul oscuro para impresi√≥n */
                text-shadow: none !important;
                font-size: 24pt;
            }
            
            header p {
                color: #555 !important;
            }

            /* Reorganizar layout para impresi√≥n vertical */
            .calculator-grid {
                display: block;
            }

            .card {
                background: none !important;
                box-shadow: none !important;
                border: 1px solid #ccc !important;
                margin-bottom: 20px;
                break-inside: avoid; /* Evitar que las tarjetas se corten entre p√°ginas */
                color: #000 !important;
            }

            .card h2 {
                color: #333 !important;
                border-bottom: 2px solid #333 !important;
            }

            /* Transformar inputs en texto est√°tico */
            input {
                border: none !important;
                background: transparent !important;
                color: #000 !important;
                padding: 0 !important;
                font-weight: bold;
                -webkit-appearance: none;
                -moz-appearance: textfield;
            }
            
            label {
                color: #666 !important;
                font-size: 0.9rem;
            }

            .input-hint {
                display: none !important;
            }

            /* Ocultar botones y elementos interactivos */
            button, .btn-group, #table-section button {
                display: none !important;
            }

            /* Estilos de tabla para impresi√≥n */
            table {
                font-size: 10pt;
                width: 100%;
                border-collapse: collapse;
            }
            
            th {
                background-color: #f3f4f6 !important;
                color: #000 !important;
                border-bottom: 2px solid #000 !important;
            }
            
            td {
                color: #000 !important;
                border-bottom: 1px solid #ddd !important;
            }

            .grace-period-row {
                background-color: #fff7ed !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .grace-period-row td {
                color: #c2410c !important;
            }

            /* M√©tricas */
            .metric-box {
                background: #fff !important;
                border: 1px solid #ddd !important;
            }
            
            .metric-label {
                color: #555 !important;
            }
            
            .metric-value {
                color: #000 !important;
            }

            .metric-box.highlight {
                background: #eff6ff !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* Indicadores */
            #van-result, #tir-result {
                color: #333 !important;
            }

            /* Gr√°fico */
            .chart-container {
                page-break-inside: avoid;
                height: 350px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Calculadora de Pr√©stamos Amoretty</h1>
        <p>Soluciones Financieras Avanzadas</p>
    </header>

    <!-- Contenedor de Error -->
    <div id="error-msg"></div>

    <div class="calculator-grid">
        <!-- SECCI√ìN 1: Entradas (Formulario) -->
        <div class="card">
            <h2>Datos del Pr√©stamo</h2>
            <form id="loan-form">
                <div class="form-group">
                    <label for="amount">Monto del Pr√©stamo ($)</label>
                    <input type="number" id="amount" placeholder="Ej: 10000" min="1" step="0.01">
                </div>

                <div class="form-group">
                    <label for="rate">Tasa de Inter√©s Anual (%)</label>
                    <input type="number" id="rate" placeholder="Ej: 12.5" min="0.01" step="0.01">
                </div>

                <div class="form-group">
                    <label for="term">Plazo (Meses)</label>
                    <input type="number" id="term" placeholder="Ej: 24" min="1" step="1">
                </div>

                <div class="form-group">
                    <label for="grace">Meses de Gracia (Opcional)</label>
                    <input type="number" id="grace" value="0" min="0" step="1">
                    <div class="input-hint">Los intereses se capitalizan durante este periodo.</div>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn-primary" onclick="calculateLoan()">Calcular</button>
                    <button type="button" class="btn-secondary" onclick="clearForm()">Limpiar</button>
                </div>
            </form>
        </div>

        <!-- SECCI√ìN 2: Resumen de Resultados -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="border: none; margin: 0; padding: 0;">Resumen Financiero</h2>
                <!-- Bot√≥n de impresi√≥n visible solo si hay resultados (se controla via CSS/JS logic o siempre visible) -->
            </div>
            
            <div class="results-summary">
                <div class="metric-box highlight">
                    <span class="metric-label">Cuota Mensual (Estimada)</span>
                    <span class="metric-value large" id="monthly-payment">$0.00</span>
                </div>
                <div class="metric-box">
                    <span class="metric-label">Total Intereses</span>
                    <span class="metric-value" id="total-interest">$0.00</span>
                </div>
                <div class="metric-box">
                    <span class="metric-label">Total a Pagar</span>
                    <span class="metric-value" id="total-paid">$0.00</span>
                </div>
            </div>

            <!-- Indicadores Financieros Avanzados -->
            <div class="financial-indicators">
                <h3>Indicadores de Inversi√≥n</h3>
                <div style="margin-bottom: 10px;">
                    <label style="font-size: 0.9rem;">Tasa de Descuento para VAN (%): </label>
                    <input type="number" id="discount-rate" value="10" class="indicator-input" step="0.1" onchange="calculateLoan()">
                </div>
                <div class="results-summary">
                    <div class="metric-box">
                        <span class="metric-label">VAN (Valor Actual Neto)</span>
                        <span class="metric-value" id="van-result" style="font-size: 1.1rem; color: #94a3b8;">-</span>
                    </div>
                    <div class="metric-box">
                        <span class="metric-label">TIR (Tasa Interna Retorno)</span>
                        <span class="metric-value" id="tir-result" style="font-size: 1.1rem; color: #94a3b8;">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SECCI√ìN 3: Gr√°ficos -->
    <div class="card" id="chart-section" style="display: none; margin-bottom: 20px;">
        <h2>Gr√°fico de Amortizaci√≥n</h2>
        <div class="chart-container">
            <canvas id="amortizationChart"></canvas>
        </div>
    </div>

    <!-- SECCI√ìN 4: Tabla de Amortizaci√≥n -->
    <div class="card" id="table-section" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 20px;">
            <h2 style="border: none; margin: 0; padding: 0;">Tabla de Amortizaci√≥n</h2>
            <div class="btn-group" style="margin-top: 0; gap: 10px;">
                <button type="button" class="btn-print" onclick="window.print()">üñ®Ô∏è Imprimir Reporte</button>
                <button type="button" class="btn-success" onclick="exportToCSV()">Exportar a CSV</button>
            </div>
        </div>
        
        <div class="table-container">
            <table id="amortization-table">
                <thead>
                    <tr>
                        <th>Mes</th>
                        <th>Saldo Inicial</th>
                        <th>Cuota</th>
                        <th>Inter√©s</th>
                        <th>Capital</th>
                        <th>Saldo Final</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Las filas se generan con JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    /* =========================================
       L√ìGICA JAVASCRIPT
       ========================================= */

    let loanData = [];
    let myChart = null; // Instancia del gr√°fico

    const currencyFormatter = new Intl.NumberFormat('es-NI', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2
    });

    /**
     * Funci√≥n Principal: Calcular el Pr√©stamo
     */
    function calculateLoan() {
        const amount = parseFloat(document.getElementById('amount').value);
        const annualRate = parseFloat(document.getElementById('rate').value);
        const term = parseInt(document.getElementById('term').value);
        const gracePeriod = parseInt(document.getElementById('grace').value) || 0;
        const discountRate = parseFloat(document.getElementById('discount-rate').value) || 10;

        const errorDiv = document.getElementById('error-msg');
        const tableSection = document.getElementById('table-section');
        const chartSection = document.getElementById('chart-section');

        // Validaciones
        errorDiv.style.display = 'none';
        if (isNaN(amount) || amount <= 0 || isNaN(annualRate) || annualRate <= 0 || isNaN(term) || term <= 0) {
            showError("Por favor, ingrese valores num√©ricos positivos en todos los campos obligatorios.");
            return;
        }

        if (gracePeriod >= term) {
            showError("El periodo de gracia no puede ser mayor o igual al plazo total.");
            return;
        }

        // C√°lculos
        const monthlyRate = annualRate / 100 / 12;
        let balance = amount;
        let totalInterest = 0;
        let totalPaid = 0;
        let cashFlows = [-amount]; 
        
        // Arrays para el gr√°fico
        let chartLabels = [];
        let chartCapital = [];
        let chartInterest = [];
        let chartBalance = [];
        let chartStartBalance = [];

        loanData = [];
        const tbody = document.querySelector('#amortization-table tbody');
        tbody.innerHTML = '';

        // FASE A: Periodo de Gracia
        for (let i = 1; i <= gracePeriod; i++) {
            const interest = balance * monthlyRate;
            const payment = 0;
            const principal = -interest; 
            
            const startBalance = balance;
            balance += interest;
            
            addRow(i, startBalance, payment, interest, principal, balance, true);
            cashFlows.push(0);

            // Datos gr√°fico (Meses de gracia: capital es 0 o negativo visualmente)
            chartLabels.push(`Mes ${i}`);
            chartCapital.push(0); 
            chartInterest.push(interest);
            chartBalance.push(balance);
            chartStartBalance.push(startBalance);
        }

        // FASE B: Amortizaci√≥n Normal
        const remainingMonths = term - gracePeriod;
        let monthlyPayment = 0;

        if (monthlyRate > 0) {
            monthlyPayment = balance * (monthlyRate * Math.pow(1 + monthlyRate, remainingMonths)) / (Math.pow(1 + monthlyRate, remainingMonths) - 1);
        } else {
            monthlyPayment = balance / remainingMonths;
        }

        document.getElementById('monthly-payment').innerText = currencyFormatter.format(monthlyPayment);

        for (let i = gracePeriod + 1; i <= term; i++) {
            const interest = balance * monthlyRate;
            let principal = monthlyPayment - interest;
            
            if (i === term && balance > principal) {
                // Ajuste simple final
            }

            const startBalance = balance;
            balance -= principal;
            if (balance < 0.01) balance = 0;

            totalInterest += interest;
            totalPaid += monthlyPayment;

            addRow(i, startBalance, monthlyPayment, interest, principal, balance, false);
            cashFlows.push(monthlyPayment);
            
            // Datos gr√°fico
            chartLabels.push(`Mes ${i}`);
            chartCapital.push(principal);
            chartInterest.push(interest);
            chartBalance.push(balance);
            chartStartBalance.push(startBalance);
        }

        // UI Updates
        document.getElementById('total-interest').innerText = currencyFormatter.format(totalInterest);
        document.getElementById('total-paid').innerText = currencyFormatter.format(totalPaid);
        tableSection.style.display = 'block';
        chartSection.style.display = 'block';

        calculateAdvancedMetrics(cashFlows, discountRate);
        renderChart(chartLabels, chartCapital, chartInterest, chartBalance, chartStartBalance);
    }

    function addRow(month, startBal, payment, interest, principal, endBal, isGrace) {
        const tbody = document.querySelector('#amortization-table tbody');
        const tr = document.createElement('tr');
        if (isGrace) tr.classList.add('grace-period-row');

        tr.innerHTML = `
            <td>${month}</td>
            <td>${currencyFormatter.format(startBal)}</td>
            <td>${currencyFormatter.format(payment)}</td>
            <td>${currencyFormatter.format(interest)}</td>
            <td>${currencyFormatter.format(isGrace ? 0 : principal)}</td>
            <td>${currencyFormatter.format(endBal)}</td>
        `;
        tbody.appendChild(tr);

        loanData.push({
            mes: month,
            saldo_inicial: startBal.toFixed(2),
            cuota: payment.toFixed(2),
            interes: interest.toFixed(2),
            capital: principal.toFixed(2),
            saldo_final: endBal.toFixed(2)
        });
    }

    /* ============================
       L√≥gica del Gr√°fico (Chart.js)
       ============================ */
    function renderChart(labels, capitalData, interestData, balanceData, startBalanceData) {
        const ctx = document.getElementById('amortizationChart').getContext('2d');
        
        // Si ya existe un gr√°fico, destr√∫yelo para crear uno nuevo
        if (myChart) {
            myChart.destroy();
        }

        myChart = new Chart(ctx, {
            type: 'bar', // Tipo base es barras mixtas
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Inter√©s Pagado',
                        data: interestData,
                        backgroundColor: 'rgba(248, 113, 113, 0.7)', // Rojo suave
                        borderColor: 'rgba(248, 113, 113, 1)',
                        borderWidth: 1,
                        order: 2,
                        stack: 'stack1'
                    },
                    {
                        label: 'Abono a Capital',
                        data: capitalData,
                        backgroundColor: 'rgba(52, 211, 153, 0.7)', // Verde suave
                        borderColor: 'rgba(52, 211, 153, 1)',
                        borderWidth: 1,
                        order: 3,
                        stack: 'stack1'
                    },
                    {
                        label: 'Saldo Final',
                        data: balanceData,
                        type: 'line', // L√≠nea superpuesta
                        borderColor: 'rgba(96, 165, 250, 1)', // Azul
                        backgroundColor: 'rgba(96, 165, 250, 0.1)',
                        borderWidth: 3,
                        pointRadius: 2,
                        yAxisID: 'y1', // Eje secundario
                        order: 1,
                        fill: true,
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        labels: {
                            // Usamos un color gris medio que funciona en ambos (oscuro y papel blanco)
                            // O podr√≠amos detectar media query en JS, pero un gris intermedio es seguro.
                            color: '#64748b' 
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#64748b' },
                        grid: { color: '#334155' } // En impresi√≥n el grid ser√° tenue pero visible
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'Cuota / Composici√≥n', color: '#64748b' },
                        ticks: { color: '#64748b' },
                        grid: { color: '#334155' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: true, text: 'Saldo Deudor', color: '#60a5fa' },
                        ticks: { color: '#60a5fa' },
                        grid: { drawOnChartArea: false }, // Evita gridlines duplicadas
                        min: 0
                    }
                }
            }
        });
    }

    /* ============================
       C√°lculos Avanzados & Utils
       ============================ */
    function calculateAdvancedMetrics(cashFlows, discountRatePercentage) {
        const r = discountRatePercentage / 100 / 12;
        let van = 0;
        for (let t = 0; t < cashFlows.length; t++) {
            van += cashFlows[t] / Math.pow(1 + r, t);
        }

        let guess = 0.1 / 12;
        let tirMonthly = 0;
        try {
            tirMonthly = computeIRR(cashFlows, guess);
        } catch (e) {
            tirMonthly = NaN;
        }
        
        const tirAnnual = (Math.pow(1 + tirMonthly, 12) - 1) * 100;

        document.getElementById('van-result').innerText = currencyFormatter.format(van);
        document.getElementById('tir-result').innerText = isNaN(tirAnnual) ? "N/A" : tirAnnual.toFixed(2) + "%";
        
        const vanEl = document.getElementById('van-result');
        if (van > 0) vanEl.style.color = "var(--success-color)";
        else vanEl.style.color = "var(--danger-color)";
    }

    function computeIRR(values, guess) {
        const maxIter = 1000;
        const precision = 1e-7;
        let rate = guess;

        for (let i = 0; i < maxIter; i++) {
            let npv = 0;
            let d_npv = 0;
            for (let t = 0; t < values.length; t++) {
                npv += values[t] / Math.pow(1 + rate, t);
                d_npv -= t * values[t] / Math.pow(1 + rate, t + 1);
            }
            if (Math.abs(npv) < precision) return rate;
            if (d_npv === 0) return NaN;
            const newRate = rate - npv / d_npv;
            if (Math.abs(newRate - rate) < precision) return newRate;
            rate = newRate;
        }
        return NaN;
    }

    function clearForm() {
        document.getElementById('loan-form').reset();
        document.getElementById('monthly-payment').innerText = "$0.00";
        document.getElementById('total-interest').innerText = "$0.00";
        document.getElementById('total-paid').innerText = "$0.00";
        document.getElementById('van-result').innerText = "-";
        document.getElementById('tir-result').innerText = "-";
        document.getElementById('table-section').style.display = 'none';
        document.getElementById('chart-section').style.display = 'none'; // Ocultar gr√°fico
        document.getElementById('error-msg').style.display = 'none';
        loanData = [];
        if(myChart) myChart.destroy(); // Limpiar gr√°fico
    }

    function showError(message) {
        const div = document.getElementById('error-msg');
        div.innerText = message;
        div.style.display = 'block';
        window.scrollTo(0, 0);
    }

    function exportToCSV() {
        if (loanData.length === 0) {
            showError("No hay datos para exportar. Calcula primero.");
            return;
        }
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Mes,Saldo Inicial,Cuota,Interes,Capital,Saldo Final\r\n";
        loanData.forEach(function(row) {
            let rowString = `${row.mes},${row.saldo_inicial},${row.cuota},${row.interes},${row.capital},${row.saldo_final}`;
            csvContent += rowString + "\r\n";
        });
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "tabla_amortizacion_amoretty.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

</body>
</html>